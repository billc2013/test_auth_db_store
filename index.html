<!DOCTYPE html>
<html>
<head>
    <title>Minimal Auth0 Test</title>
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
</head>
<body>
    <h1>Minimal Auth0 Test</h1>
    <button id="login">Login</button>
    <div id="status"></div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        
        // Firebase config
        const firebaseConfig = {
          apiKey: "AIzaSyC5nQrhR3-Z8NCCtSbOa25mkcC3-8KHQCc",
          authDomain: "webr-1de0a.firebaseapp.com",
          projectId: "webr-1de0a",
          storageBucket: "webr-1de0a.firebasestorage.app",
          messagingSenderId: "845544523689",
          appId: "1:845544523689:web:dfce9e291c1829f527e6b8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Add a more structured document
        const testFirestore = async (accessToken) => {
            try {
                const docRef = await addDoc(collection(db, "users"), {
                    message: "Test from Auth0 user",
                    timestamp: new Date(),
                    tokenPreview: accessToken.substring(0, 10) + "...",
                    lastLogin: new Date()
                });
                console.log("Document written with ID: ", docRef.id);
                
                // Add success UI feedback
                document.getElementById('status').textContent += 
                    `\nFirestore write successful! Doc ID: ${docRef.id}`;
            } catch (e) {
                console.error("Error adding document: ", e);
                document.getElementById('status').textContent += 
                    `\nFirestore error: ${e.message}`;
            }
        };

        // Auth0 login button handler
        document.getElementById('login').addEventListener('click', () => {
            const auth0Domain = 'dev-dfbbkd2f8l4ykviq.us.auth0.com';
            const clientId = '7UMbmSJEOa0ZqEObjxJmMwY9RFwQxerv';
            const redirectUri = window.location.origin;
            
            const auth0LoginUrl = `https://${auth0Domain}/authorize?` +
                `response_type=token&` +
                `client_id=${clientId}&` +
                `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                `scope=openid profile email`;
            
            window.location.href = auth0LoginUrl;
        });

        // Check for authentication response
        if (window.location.hash) {
            const params = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = params.get('access_token');
            if (accessToken) {
                document.getElementById('status').textContent = 'Logged in!';
                
                // Add logout button
                const logoutBtn = document.createElement('button');
                logoutBtn.textContent = 'Logout';
                logoutBtn.onclick = () => {
                    window.location.href = '/';
                };
                document.getElementById('status').appendChild(logoutBtn);
                
                console.log('Access Token:', accessToken);
                console.log('Firebase initialized:', !!db);
                
                // Test Firestore write
                const docRef = await testFirestore(accessToken);

                // Test Firestore read
                await testRead(docRef.id);
                
                // Test Storage
                await testStorage();
            }
        }

        // Initialize Storage
        const storage = getStorage(app);

        // Test Firestore Read
        const testRead = async (docId) => {
            try {
                const docRef = doc(db, "users", docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    console.log("Document data:", docSnap.data());
                    document.getElementById('status').textContent += 
                        `\nRead successful: ${JSON.stringify(docSnap.data())}`;
                }
            } catch (e) {
                console.error("Error reading document: ", e);
            }
        };

        // Test Storage
        const testStorage = async () => {
            try {
                // Create a test blob
                const testBlob = new Blob(['Hello, Storage!'], { type: 'text/plain' });
                
                // Create a reference
                const storageRef = ref(storage, 'test/hello.txt');
                
                // Upload
                const snapshot = await uploadBytes(storageRef, testBlob);
                console.log('Uploaded file!');
                
                // Get download URL
                const url = await getDownloadURL(snapshot.ref);
                console.log('File available at:', url);
                
                document.getElementById('status').textContent += 
                    `\nStorage test successful! URL: ${url}`;
            } catch (e) {
                console.error("Storage error: ", e);
                document.getElementById('status').textContent += 
                    `\nStorage error: ${e.message}`;
            }
        };
        
    </script>
</body>
</html>
